// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model usuario {
  id                  String               @id @default(uuid())
  nome                String
  email               String               @unique
  avatar              String?
  criado_em           DateTime             @default(now())
  grupo               grupo[]
  grupo_participante  grupo_participante[]
  sorteios_recebidos  sorteio_resultado[]  @relation("SorteioResultadoRecebido")
  sorteios_enviados   sorteio_resultado[]  @relation("SorteioResultadoEnviado")
  mensagens_recebidas mensagem[]           @relation("MensagemRecebida")
  mensagens_enviadas  mensagem[]           @relation("MensagemEnviada")
  notificacoes        notificacao[]
}

model grupo {
  id             String    @id @default(uuid())
  criado_por     String
  slug           String    @unique
  titulo         String
  descricao      String?
  data_sorteio   DateTime?
  data_revelacao DateTime?
  status         String
  criado_em      DateTime  @default(now())

  usuario       usuario              @relation(fields: [criado_por], references: [id], onDelete: Cascade)
  metadata      grupo_metadata?
  grupo_tag     grupo_tag[]
  participantes grupo_participante[]
  sorteios      sorteio[]
  mensagens     mensagem[]
  convites      convite[]
  notificacao   notificacao[]
}

model grupo_metadata {
  grupo_id              String   @id
  tipo_presente         String?
  orcamento_minimo      Decimal?
  orcamento_maximo      Decimal?
  orcamento_sem_limites Boolean  @default(false)
  localizacao           String?
  localizacao_nome      String?
  localizacao_lat       Float?
  localizacao_lng       Float?

  grupo grupo @relation(fields: [grupo_id], references: [id], onDelete: Cascade)
}

model grupo_tag {
  grupo_id String
  tag      String

  grupo grupo @relation(fields: [grupo_id], references: [id], onDelete: Cascade)

  @@id([grupo_id, tag])
}

model grupo_participante {
  grupo_id      String
  usuario_id    String
  perfil        String?
  is_confirmado Boolean   @default(false)
  is_revelado   Boolean   @default(false)
  is_ativo      Boolean   @default(true)
  criado_em     DateTime  @default(now())
  aderido_em    DateTime?

  grupo   grupo   @relation(fields: [grupo_id], references: [id], onDelete: Cascade)
  usuario usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@id([grupo_id, usuario_id])
}

model sorteio {
  id          String    @id @default(uuid())
  grupo_id    String
  sorteado_em DateTime? @default(now())
  status      String

  grupo      grupo               @relation(fields: [grupo_id], references: [id], onDelete: Cascade)
  resultados sorteio_resultado[]
}

model sorteio_resultado {
  sorteio_id    String
  recipiente_id String
  remetente_id  String

  sorteio    sorteio @relation(fields: [sorteio_id], references: [id], onDelete: Cascade)
  recipiente usuario @relation("SorteioResultadoRecebido", fields: [recipiente_id], references: [id], onDelete: Cascade)
  remetente  usuario @relation("SorteioResultadoEnviado", fields: [remetente_id], references: [id], onDelete: Cascade)

  @@id([sorteio_id, remetente_id])
}

model mensagem {
  id            String    @id @default(uuid())
  grupo_id      String
  recipiente_id String?
  remetente_id  String
  body          String
  criado_em     DateTime  @default(now())
  deletado_em   DateTime?
  is_secret     Boolean   @default(false)

  grupo      grupo    @relation(fields: [grupo_id], references: [id], onDelete: Cascade)
  recipiente usuario? @relation("MensagemRecebida", fields: [recipiente_id], references: [id], onDelete: Cascade)
  remetente  usuario  @relation("MensagemEnviada", fields: [remetente_id], references: [id], onDelete: Cascade)
  notificacoes notificacao[] @relation("NotificacaoMensagem")
}

model convite {
  id         String    @id @default(uuid())
  grupo_id   String
  email      String?
  telefone   String?
  token      String    @unique
  status     String    @default("pendente")
  enviado_em DateTime?
  aceito_em  DateTime?
  criado_em  DateTime  @default(now())

  grupo grupo @relation(fields: [grupo_id], references: [id], onDelete: Cascade)
}

model notificacao {
  id         String    @id @default(uuid())
  usuario_id String
  title      String
  body       String
  lido       Boolean   @default(false)
  lido_em    DateTime?
  created_at DateTime  @default(now())
  grupo_id   String?
  mensagem_id String?

  usuario usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  grupo   grupo?  @relation(fields: [grupo_id], references: [id], onDelete: Cascade)
  mensagem mensagem? @relation("NotificacaoMensagem", fields: [mensagem_id], references: [id], onDelete: Cascade)

  @@index([mensagem_id], map: "idx_notificacao_mensagem_id")
}
