---
import Layout from '../../../layouts/Layout.astro';
import AppHeader from '../../../components/AppHeader.astro';
import Footer from '../../../components/Footer.astro';
import UpdateItem from '../../../components/UpdateItem.astro';
import ActionButton from '../../../components/ActionButton.astro';
import { computeInitials, renderMessageList } from '../../../utils/message-renderer';
import { sendDrawCompletedEmail, sendInviteEmail } from '../../../../../shared/utils/email';
import { notifyDrawCompletedByPhone, notifyInviteByPhone } from '../../../../../shared/utils/twilio';

export const prerender = false;

const env = Astro.locals.cloudflare?.env ?? Astro.locals.runtime?.env ?? Astro.locals?.env;
const sessionCookie = Astro.cookies.get('felizNatalSession');
const slug = Astro.params.slug;

const userId = sessionCookie?.value ?? null;

if (!userId) {
	return Astro.redirect('/app/');
}

if (!env?.DB || !slug) {
	return new Response('<div>Grupo n√£o encontrado.</div>', {
		status: 404,
		headers: { 'Content-Type': 'text/html; charset=utf-8' }
	});
}

const grupoRow = await env.DB.prepare(
	`SELECT
		g.id,
		g.slug,
		g.titulo,
		g.descricao,
		g.data_sorteio,
		g.data_revelacao,
		g.status,
		g.criado_em,
		g.criado_por,
		gm.tipo_presente,
		gm.orcamento_minimo,
		gm.orcamento_maximo,
		gm.orcamento_sem_limites,
		gm.localizacao,
		gm.localizacao_nome,
		gm.localizacao_lat,
		gm.localizacao_lng
	 FROM grupo g
	 LEFT JOIN grupo_metadata gm ON gm.grupo_id = g.id
	 WHERE g.slug = ?
	 LIMIT 1`
)
	.bind(slug)
	.first();

if (!grupoRow) {
	return new Response('<div>Grupo n√£o encontrado.</div>', {
		status: 404,
		headers: { 'Content-Type': 'text/html; charset=utf-8' }
	});
}

const groupStatusValue = (grupoRow as { status?: string | null }).status ?? 'indefinido';
if (groupStatusValue !== 'ativo') {
	return Astro.redirect('/app/grupos');
}

const organizerId = (grupoRow as { criado_por?: string | null }).criado_por ?? null;
const isOrganizer = organizerId === userId;

let isParticipant = isOrganizer;

if (!isParticipant) {
	const participation = await env.DB.prepare(
		'SELECT 1 FROM grupo_participante WHERE grupo_id = ? AND usuario_id = ? LIMIT 1'
	)
		.bind((grupoRow as { id: string }).id, userId)
		.first();

	isParticipant = Boolean(participation);
}

if (!isParticipant) {
	return Astro.redirect('/app/');
}

const canEdit = isOrganizer;
const groupId = (grupoRow as { id: string }).id;

let submissionError: string | null = null;
let draftMessage = '';
let drawError: string | null = null;
let secretMessageError: string | null = null;
let secretDraft = '';

const createNotification = async (
	targetUserId: string | null,
	title: string,
	body: string,
	groupTargetId: string | null = null,
	messageId: string | null = null
) => {
	if (!targetUserId) return;
	try {
		await env.DB.prepare(
			`INSERT INTO notificacao (id, usuario_id, grupo_id, mensagem_id, title, body, lido, created_at)
			 VALUES (?, ?, ?, ?, ?, ?, 0, ?)`
		)
			.bind(
				crypto.randomUUID(),
				targetUserId,
				groupTargetId,
				messageId,
				title,
				body,
				new Date().toISOString()
			)
			.run();
	} catch (error) {
		console.error('Erro ao criar notifica√ß√£o:', error);
	}
};

const ensureNotification = async (
	targetUserId: string | null,
	title: string,
	body: string,
	groupTargetId: string | null = null
) => {
	if (!targetUserId) return;
	try {
		const existing = await env.DB.prepare(
			`SELECT id
			 FROM notificacao
			 WHERE usuario_id = ?
			   AND COALESCE(grupo_id, '') = COALESCE(?, '')
			   AND title = ?
			   AND body = ?
			   AND lido = 0
			   AND datetime(created_at) >= datetime(?, '-1 day')
			 LIMIT 1`
		)
			.bind(targetUserId, groupTargetId, title, body, new Date().toISOString())
			.first();

		if (!existing) {
			await createNotification(targetUserId, title, body, groupTargetId);
		}
	} catch (error) {
		console.error('Erro ao garantir notifica√ß√£o:', error);
	}
};

if (Astro.request.method === 'POST') {
	const formData = await Astro.request.formData();
	const intent = formData.get('intent')?.toString() ?? 'message';
	const isHtmxRequest = (Astro.request.headers.get('hx-request') ?? '').toLowerCase() === 'true';
	const isAjaxRequest =
		isHtmxRequest || (Astro.request.headers.get('x-requested-with') ?? '').toLowerCase() === 'xmlhttprequest';
	const respondJson = (body: Record<string, unknown>, status = 200, extraHeaders: Record<string, string> = {}) =>
		new Response(JSON.stringify(body), {
			status,
			headers: { 'Content-Type': 'application/json; charset=utf-8', ...extraHeaders }
		});
	const respondText = (message: string, status = 400) =>
		new Response(message, {
			status,
			headers: { 'Content-Type': 'text/plain; charset=utf-8' }
		});

	if (intent === 'message') {
		const bodyRaw = formData.get('body');
		const bodyString =
			typeof bodyRaw === 'string'
				? bodyRaw
				: bodyRaw
					? bodyRaw.toString()
					: '';
		draftMessage = bodyString;
		const messageContent = bodyString.trim();

		if (!messageContent) {
			submissionError = 'Digite uma mensagem antes de enviar.';
		} else {
			try {
				await env.DB.prepare(
					`INSERT INTO mensagem (id, grupo_id, remetente_id, body)
					 VALUES (?, ?, ?, ?)`
				)
					.bind(crypto.randomUUID(), groupId, userId, messageContent)
					.run();

				const redirectTarget = `${Astro.url.pathname}${Astro.url.search}`;
				return Astro.redirect(redirectTarget);
			} catch (error) {
				console.error('Erro ao salvar mensagem do grupo:', error);
				submissionError = 'N√£o foi poss√≠vel enviar a mensagem agora.';
			}
		}
	} else if (intent === 'secret-message') {
		const bodyRaw = formData.get('body');
		const recipientRaw = formData.get('recipient_id');
		const bodyString =
			typeof bodyRaw === 'string'
				? bodyRaw
				: bodyRaw
					? bodyRaw.toString()
					: '';
		const recipientId =
			typeof recipientRaw === 'string'
				? recipientRaw.trim()
				: recipientRaw
					? recipientRaw.toString().trim()
					: '';

		secretDraft = bodyString;
		const messageContent = bodyString.trim();

		if (!recipientId) {
			secretMessageError = 'N√£o foi poss√≠vel identificar o destinat√°rio da mensagem secreta.';
		} else if (!messageContent) {
			secretMessageError = 'Digite uma mensagem secreta antes de enviar.';
		} else {
			try {
				const messageId = crypto.randomUUID();
				await env.DB.prepare(
					`INSERT INTO mensagem (id, grupo_id, remetente_id, recipiente_id, body, is_secret)
					 VALUES (?, ?, ?, ?, ?, 1)`
				)
					.bind(messageId, groupId, userId, recipientId, messageContent)
					.run();

				await createNotification(
					recipientId,
					'Mensagem Recebida',
					'Seu amigo te mandou uma mensagem. Veja aqui',
					groupId,
					messageId
				);

				const redirectTarget = `${Astro.url.pathname}${Astro.url.search}`;
				return Astro.redirect(redirectTarget);
			} catch (error) {
				console.error('Erro ao enviar mensagem secreta do grupo:', error);
				secretMessageError = 'N√£o foi poss√≠vel enviar a mensagem secreta agora.';
			}
		}
	} else if (intent === 'draw') {
		try {
			const participantsQuery = await env.DB.prepare(
				`SELECT usuario_id
				 FROM grupo_participante
				 WHERE grupo_id = ?
				   AND is_ativo = 1`
			)
				.bind(groupId)
				.all();

			const participantIdsRaw = (participantsQuery?.results ?? [])
				.map((row) => (row as { usuario_id: string }).usuario_id)
				.filter(Boolean);
			const participantIds = Array.from(new Set(participantIdsRaw));

			if (participantIds.length < 2) {
				drawError = '√â necess√°rio pelo menos 2 participantes ativos para realizar o sorteio.';
				if (isHtmxRequest) {
					return respondText(drawError, 400);
				}
				if (isAjaxRequest) {
					return respondJson({ ok: false, error: drawError }, 400);
				}
			} else {
				const shuffle = <T,>(items: T[]) => {
					const array = [...items];
					for (let index = array.length - 1; index > 0; index -= 1) {
						const randomIndex = Math.floor(Math.random() * (index + 1));
						[array[index], array[randomIndex]] = [array[randomIndex], array[index]];
					}
					return array;
				};

				let recipients = [...participantIds];
				let attempt = 0;
				let isValid = false;

				while (attempt < 100 && !isValid) {
					attempt += 1;
					recipients = shuffle(participantIds);
					isValid = participantIds.every((id, index) => recipients[index] !== id);
				}

				if (!isValid) {
					drawError = 'N√£o foi poss√≠vel concluir o sorteio. Tente novamente.';
					if (isHtmxRequest) {
						return respondText(drawError, 400);
					}
					if (isAjaxRequest) {
						return respondJson({ ok: false, error: drawError }, 400);
					}
				} else {
					const sorteioId = crypto.randomUUID();
					const sorteadoEm = new Date().toISOString();
					const groupTitle = (grupoRow as { titulo: string }).titulo;
					const groupSlug = (grupoRow as { slug: string }).slug;
					const revealDateValue = (grupoRow as { data_revelacao?: string | null }).data_revelacao ?? null;
					const revealDateText = (() => {
						if (!revealDateValue) return null;
						const date = new Date(revealDateValue);
						return Number.isNaN(date.getTime())
							? null
							: date.toLocaleDateString('pt-BR', {
									day: '2-digit',
									month: 'long',
									year: 'numeric'
								});
					})();
					const groupUrl = new URL(`/app/grupo/${groupSlug}`, Astro.url).toString();

					await env.DB.prepare(
						`INSERT INTO sorteio (id, grupo_id, sorteado_em, status)
						 VALUES (?, ?, ?, ?)`
					)
						.bind(sorteioId, groupId, sorteadoEm, 'concluido')
						.run();

					const insertResultado = env.DB.prepare(
						`INSERT INTO sorteio_resultado (sorteio_id, remetente_id, recipiente_id)
						 VALUES (?, ?, ?)`
					);

					const notificationPromises: Array<Promise<void>> = [];
					const emailPromises: Array<Promise<unknown>> = [];
					const phoneNumbers = new Set<string>();
					const participantContacts = new Map<
						string,
						{ email: string; nome?: string | null }
					>();

					if (participantIds.length > 0) {
						const placeholders = participantIds.map(() => '?').join(', ');
						try {
							const contactsResult = await env.DB.prepare(
								`SELECT id, email, nome
								 FROM usuario
								 WHERE id IN (${placeholders})`
							)
								.bind(...participantIds)
								.all();

							for (const row of contactsResult?.results ?? []) {
								const record = row as { id: string; email?: string | null; nome?: string | null };
								if (record?.id && record.email) {
									participantContacts.set(record.id, {
										email: record.email,
										nome: record.nome
									});
								}
							}
						} catch (error) {
							console.error('Erro ao carregar emails dos participantes:', error);
						}
					}

					try {
						const phonesResult = await env.DB.prepare(
							`SELECT DISTINCT telefone
							 FROM convite
							 WHERE grupo_id = ?
							   AND telefone IS NOT NULL
							   AND TRIM(telefone) != ''`
						)
							.bind(groupId)
							.all();

						for (const row of phonesResult?.results ?? []) {
							const phone = (row as { telefone?: string | null }).telefone?.trim();
							if (phone) {
								phoneNumbers.add(phone);
							}
						}
					} catch (error) {
						console.error('Erro ao carregar telefones dos convites:', error);
					}

					for (let index = 0; index < participantIds.length; index += 1) {
						const giverId = participantIds[index];
						const recipientId = recipients[index];

						await insertResultado
							.bind(sorteioId, giverId, recipientId)
							.run();

						notificationPromises.push(
							createNotification(
								recipientId,
								'Sorteio realizado',
								'Veja s√≥ quem voc√™ tirou clicando aqui',
								groupId
							)
						);

						const contact = participantContacts.get(giverId);
						if (contact?.email) {
							const displayName =
								contact.nome?.trim() ||
								(contact.email.includes('@') ? contact.email.split('@')[0] ?? null : null);
							emailPromises.push(
								sendDrawCompletedEmail(env, {
									to: contact.email,
									groupTitle,
									groupUrl,
									revealDate: revealDateValue,
									participantName: displayName
								})
							);
						}
					}

					const phoneNotificationPromises = Array.from(phoneNumbers).map((phone) =>
						notifyDrawCompletedByPhone(env, {
							phone,
							groupTitle,
							groupUrl,
							revealDate: revealDateText
						})
					);

					await Promise.all([...notificationPromises, ...emailPromises, ...phoneNotificationPromises]);

					const redirectTarget = `${Astro.url.pathname}${Astro.url.search}`;
					if (isHtmxRequest) {
						return new Response(null, {
							status: 204,
							headers: { 'HX-Redirect': redirectTarget }
						});
					}
					if (isAjaxRequest) {
						return respondJson({ ok: true, redirectUrl: redirectTarget });
					}
					return Astro.redirect(redirectTarget);
				}
			}
		} catch (error) {
			console.error('Erro ao realizar o sorteio do grupo:', error);
			drawError = 'N√£o foi poss√≠vel realizar o sorteio agora.';
			if (isHtmxRequest) {
				return respondText(drawError ?? 'N√£o foi poss√≠vel realizar o sorteio agora.', 500);
			}
			if (isAjaxRequest) {
				return respondJson(
					{ ok: false, error: drawError ?? 'N√£o foi poss√≠vel realizar o sorteio agora.' },
					500
				);
			}
		}
	} else if (intent === 'resend-invite') {
		if (!canEdit) {
			return respondText('Apenas o organizador pode reenviar convites.', 403);
		}
		const inviteIdRaw = formData.get('invite_id');
		const inviteId =
			typeof inviteIdRaw === 'string'
				? inviteIdRaw.trim()
				: inviteIdRaw
					? inviteIdRaw.toString().trim()
					: '';
		if (!inviteId) {
			return respondText('Convite inv√°lido.', 400);
		}

		try {
			const inviteRow = await env.DB.prepare(
				`SELECT id, email, telefone, token, status
				 FROM convite
				 WHERE id = ?
				   AND grupo_id = ?
				 LIMIT 1`
			)
				.bind(inviteId, groupId)
				.first();

			if (!inviteRow) {
				return respondText('Convite n√£o encontrado.', 404);
			}

			const inviteEmail = (inviteRow as { email?: string | null }).email?.trim();
			const invitePhone = (inviteRow as { telefone?: string | null }).telefone?.trim();
			const inviteToken = (inviteRow as { token: string }).token;
			const groupTitle = (grupoRow as { titulo: string }).titulo;
			const inviteLink = new URL(
				`/convite?token=${encodeURIComponent(inviteToken)}`,
				Astro.url
			).toString();

			if (inviteEmail) {
				await sendInviteEmail(env, {
					to: inviteEmail,
					groupTitle,
					inviteLink,
					inviterName: null
				});
			} else if (invitePhone) {
				await notifyInviteByPhone(env, {
					phone: invitePhone,
					groupTitle,
					inviteLink
				});
			} else {
				return respondText('Este convite n√£o possui contato configurado.', 400);
			}

			await env.DB.prepare(`UPDATE convite SET enviado_em = ? WHERE id = ?`)
				.bind(new Date().toISOString(), inviteId)
				.run();

			const redirectTarget = `${Astro.url.pathname}${Astro.url.search}`;
			if (isHtmxRequest) {
				return new Response(null, {
					status: 204,
					headers: { 'HX-Redirect': redirectTarget }
				});
			}
			return Astro.redirect(redirectTarget);
		} catch (error) {
			console.error('Erro ao reenviar convite:', error);
			return respondText('N√£o foi poss√≠vel reenviar o convite agora.', 500);
		}
	} else if (intent === 'delete-invite') {
		if (!canEdit) {
			return respondText('Apenas o organizador pode apagar convites.', 403);
		}
		const inviteIdRaw = formData.get('invite_id');
		const inviteId =
			typeof inviteIdRaw === 'string'
				? inviteIdRaw.trim()
				: inviteIdRaw
					? inviteIdRaw.toString().trim()
					: '';
		if (!inviteId) {
			return respondText('Convite inv√°lido.', 400);
		}

		try {
			await env.DB.prepare(
				`DELETE FROM convite
				 WHERE id = ?
				   AND grupo_id = ?`
			)
				.bind(inviteId, groupId)
				.run();

			const redirectTarget = `${Astro.url.pathname}${Astro.url.search}`;
			if (isHtmxRequest) {
				return new Response(null, {
					status: 204,
					headers: { 'HX-Redirect': redirectTarget }
				});
			}
			return Astro.redirect(redirectTarget);
		} catch (error) {
			console.error('Erro ao apagar convite:', error);
			return respondText('N√£o foi poss√≠vel apagar o convite agora.', 500);
		}
	} else if (intent === 'deactivate-group') {
		if (!canEdit) {
			return respondText('Apenas o organizador pode apagar o grupo.', 403);
		}

		try {
			await env.DB.prepare(`UPDATE grupo SET status = ? WHERE id = ?`)
				.bind('inativo', groupId)
				.run();

			const redirectTarget = '/app/grupos';
			if (isHtmxRequest) {
				return new Response(null, {
					status: 204,
					headers: { 'HX-Redirect': redirectTarget }
				});
			}
			return Astro.redirect(redirectTarget);
		} catch (error) {
			console.error('Erro ao apagar grupo:', error);
			return respondText('N√£o foi poss√≠vel apagar o grupo agora.', 500);
		}
	}
}

const participantsResult = await env.DB.prepare(
	`SELECT gp.usuario_id, gp.criado_em, gp.is_confirmado, COALESCE(u.nome, u.email, 'Participante') AS nome
	 FROM grupo_participante gp
	 JOIN usuario u ON u.id = gp.usuario_id
	 WHERE gp.grupo_id = ?
	   AND gp.is_ativo = 1
	 ORDER BY gp.criado_em ASC`
)
	.bind(groupId)
	.all();

const participantRecords = (participantsResult?.results ?? []) as Array<{
	usuario_id: string;
	nome: string;
	criado_em?: string | null;
	is_confirmado?: number | boolean | null;
}>;
const participantsList = participantRecords.map((record) => record.nome);

const pendingInvitesResult = await env.DB.prepare(
	`SELECT id, email, telefone, status
	 FROM convite
	 WHERE grupo_id = ?
	   AND status = 'pendente'`
)
	.bind(groupId)
	.all();

const pendingInviteRecords = (pendingInvitesResult?.results ?? []) as Array<{
	id: string;
	email?: string | null;
	telefone?: string | null;
	status?: string | null;
}>;

const groupStatus = groupStatusValue;
const isGroupActive = groupStatus === 'ativo';

const formatDateValue = (value?: string | null) => {
	if (!value) return null;
	const date = new Date(value);
	if (Number.isNaN(date.getTime())) return null;
	return date.toLocaleDateString('pt-BR', {
		day: '2-digit',
		month: 'long',
		year: 'numeric'
	});
};

const formatCurrency = (value?: number | null) => {
	if (value === null || value === undefined) return null;
	return new Intl.NumberFormat('pt-BR', {
		style: 'currency',
		currency: 'BRL',
		minimumFractionDigits: 2
	}).format(Number(value));
};

const toDateValue = (value?: string | null) => {
	if (!value) return null;
	const date = new Date(value);
	return Number.isNaN(date.getTime()) ? null : date;
};

const rawDrawDateValue = (grupoRow as { data_sorteio?: string | null }).data_sorteio ?? null;
const rawRevealDateValue = (grupoRow as { data_revelacao?: string | null }).data_revelacao ?? null;

const drawDate = formatDateValue(rawDrawDateValue);
const revealDate = formatDateValue(rawRevealDateValue);
const drawDateTimestamp = toDateValue(rawDrawDateValue);
const revealDateTimestamp = toDateValue(rawRevealDateValue);

const minBudgetText = formatCurrency((grupoRow as { orcamento_minimo?: number | null }).orcamento_minimo ?? null);
const maxBudgetText = formatCurrency((grupoRow as { orcamento_maximo?: number | null }).orcamento_maximo ?? null);

let budgetDescription = 'N√£o definido';

if ((grupoRow as { orcamento_sem_limites?: number | null }).orcamento_sem_limites) {
	budgetDescription = 'Sem limite definido';
} else if (minBudgetText && maxBudgetText) {
	budgetDescription = `${minBudgetText} - ${maxBudgetText}`;
} else if (minBudgetText) {
	budgetDescription = `A partir de ${minBudgetText}`;
} else if (maxBudgetText) {
	budgetDescription = `At√© ${maxBudgetText}`;
}

const participantCount = participantsList.length;
const locationName = (grupoRow as { localizacao_nome?: string | null }).localizacao_nome ?? null;
const locationAddress = (grupoRow as { localizacao?: string | null }).localizacao ?? null;
const giftTheme = (grupoRow as { tipo_presente?: string | null }).tipo_presente ?? null;
const displayLocation =
	locationName && locationAddress && locationName !== locationAddress
		? `${locationName} (${locationAddress})`
		: locationName ?? locationAddress;

const keyFacts = [
	{ label: 'Sorteio', value: drawDate ?? 'Data n√£o definida' },
	{ label: 'Revela√ß√£o', value: revealDate ?? 'Data n√£o definida' },
	{ label: 'Or√ßamento', value: budgetDescription }
];

const highlights = [
	`Status atual: ${(grupoRow as { status?: string | null }).status ?? 'n√£o informado'}`,
	giftTheme ? `Tema do presente: ${giftTheme}` : 'Nenhum tema definido para os presentes.',
	participantCount ? `${participantCount} participante(s) adicionados.` : 'Ainda n√£o h√° participantes cadastrados.'
];

if (displayLocation) {
	highlights.push(`Encontro planejado em ${displayLocation}.`);
}

const organizerActions = [
	{
		title: 'Gerenciar participantes',
		due: 'Enquanto houver convites',
		description: 'Convide e confirme participantes diretamente pelo painel.'
	},
	{
		title: 'Preparar sorteio',
		due: drawDate ? `Antes de ${drawDate}` : 'Defina uma data de sorteio',
		description: 'Garanta que todos os participantes estejam confirmados antes do sorteio.'
	},
	{
		title: 'Atualizar or√ßamento',
		due: 'Conforme necess√°rio',
		description: 'Mantenha o or√ßamento alinhado com a expectativa do grupo.'
	}
];

const participantActions = [
	{
		title: 'Confirmar participa√ß√£o',
		due: drawDate ? `Antes de ${drawDate}` : 'Assim que poss√≠vel',
		description: 'Mantenha seu cadastro atualizado para que o sorteio ocorra sem imprevistos.'
	},
	{
		title: 'Planejar presente',
		due: drawDate ? `At√© ${drawDate}` : 'Ap√≥s o sorteio',
		description: 'Escolha o presente ideal alinhado ao or√ßamento definido pelo grupo.'
	},
	{
		title: 'Acompanhar novidades',
		due: 'Periodicamente',
		description: 'Verifique as mensagens do organizador para n√£o perder nenhuma atualiza√ß√£o.'
	}
];

const nextActions = canEdit ? organizerActions : participantActions;

const organizerParticipantRecord =
	organizerId ? participantRecords.find((participant) => participant.usuario_id === organizerId) ?? null : null;

const orderedParticipantRecords = [
	...(organizerParticipantRecord ? [organizerParticipantRecord] : []),
	...participantRecords.filter((participant) => participant.usuario_id !== organizerId)
];

const participantEntries = [
	...orderedParticipantRecords.map((participant) => {
		const displayName = participant.nome;
		const initials = computeInitials(displayName) || displayName.slice(0, 2).toUpperCase();
		const isRecordOrganizer = organizerId ? participant.usuario_id === organizerId : false;
		const isConfirmed = Boolean(
			typeof participant.is_confirmado === 'number' ? participant.is_confirmado : participant.is_confirmado
		);
		const statusLabel = isRecordOrganizer ? 'Organizador' : isConfirmed ? 'Convite confirmado' : 'Convite pendente';
		return {
			id: participant.usuario_id,
			name: displayName,
			initials,
			isConfirmed,
			statusLabel,
			inviteTag: isRecordOrganizer ? null : isConfirmed ? null : 'Convidado',
			isPendingInvite: false,
			modalPayload: {
				userId: participant.usuario_id,
				name: displayName,
				initials,
				status: statusLabel,
				inviteId: null,
				contact: null,
				isConfirmed
			}
		};
	}),
	...pendingInviteRecords.map((invite) => {
		const contact = invite.email ?? invite.telefone ?? 'Contato n√£o informado';
		return {
			id: invite.id,
			name: 'Convite Pendente',
			initials: 'C',
			isConfirmed: false,
			statusLabel: contact,
			inviteTag: 'Convite pendente',
			isPendingInvite: true,
			modalPayload: {
				userId: null,
				name: 'Convite Pendente',
				initials: 'C',
				status: 'Convite pendente',
				inviteId: invite.id,
				contact,
				isConfirmed: false
			}
		};
	})
];

const latestDrawRow = await env.DB.prepare(
	`SELECT id, sorteado_em
	 FROM sorteio
	 WHERE grupo_id = ?
	   AND status = ?
	 ORDER BY datetime(COALESCE(sorteado_em, '1970-01-01')) DESC
	 LIMIT 1`
)
	.bind(groupId, 'concluido')
	.first();

const latestDrawId = (latestDrawRow as { id?: string } | null)?.id ?? null;
const latestDrawDateDisplay =
	(latestDrawRow as { sorteado_em?: string | null } | null)?.sorteado_em
		? formatDateValue((latestDrawRow as { sorteado_em?: string | null }).sorteado_em ?? null)
		: null;
const latestDrawTimestamp = toDateValue((latestDrawRow as { sorteado_em?: string | null } | null)?.sorteado_em ?? null);

let yourRecipientName: string | null = null;
let yourDrawerName: string | null = null;
let yourRecipientId: string | null = null;
let yourDrawerId: string | null = null;

if (latestDrawId) {
	const recipientRow = await env.DB.prepare(
		`SELECT sr.recipiente_id AS id, COALESCE(u.nome, u.email, 'Participante') AS nome
		 FROM sorteio_resultado sr
		 LEFT JOIN usuario u ON u.id = sr.recipiente_id
		 WHERE sr.sorteio_id = ?
		   AND sr.remetente_id = ?
		 LIMIT 1`
	)
		.bind(latestDrawId, userId)
		.first();

	if (recipientRow?.nome) {
		yourRecipientName = recipientRow.nome as string;
	}
	if (recipientRow?.id) {
		yourRecipientId = recipientRow.id as string;
	}

	const drawerRow = await env.DB.prepare(
		`SELECT sr.remetente_id AS id, COALESCE(u.nome, u.email, 'Participante') AS nome
		 FROM sorteio_resultado sr
		 LEFT JOIN usuario u ON u.id = sr.remetente_id
		 WHERE sr.sorteio_id = ?
		   AND sr.recipiente_id = ?
		 LIMIT 1`
	)
		.bind(latestDrawId, userId)
		.first();

	if (drawerRow?.nome) {
		yourDrawerName = drawerRow.nome as string;
	}
	if (drawerRow?.id) {
		yourDrawerId = drawerRow.id as string;
	}
}

const hasDraw = Boolean(latestDrawId);
const recipientInitials = hasDraw && yourRecipientName ? computeInitials(yourRecipientName) : '??';
const recipientDisplay = hasDraw && yourRecipientName ? yourRecipientName : 'Realize o sorteio para descobrir.';
const drawerInitials = !isGroupActive && yourDrawerName ? computeInitials(yourDrawerName) : '??';
const drawerDisplay = !isGroupActive && yourDrawerName ? yourDrawerName : '???';

let latestParticipantName: string | null = null;
let latestParticipantDate: Date | null = null;
for (let index = participantRecords.length - 1; index >= 0; index -= 1) {
	const record = participantRecords[index];
	if (record.usuario_id !== userId) {
		latestParticipantName = record.nome;
		latestParticipantDate = toDateValue(record.criado_em ?? null);
		break;
	}
}

const timelineEventsRaw: Array<{ icon: string; message: string; date: Date | null; order: number }> = [
	{
		icon: 'üìç',
		message: displayLocation ? `Encontro planejado em ${displayLocation}.` : 'Encontro ainda sem local definido.',
		date: null,
		order: 0
	},
	{
		icon: 'üßë‚Äçü§ù‚Äçüßë',
		message: participantCount
			? `${participantCount} participante(s) adicionados.`
			: 'Nenhum participante adicionado ainda.',
		date: latestParticipantDate,
		order: 1
	},
	{
		icon: 'üóìÔ∏è',
		message: latestDrawDateDisplay
			? `Sorteio realizado em ${latestDrawDateDisplay}.`
			: 'Sorteio ainda n√£o realizado.',
		date: latestDrawTimestamp,
		order: 2
	},
	{
		icon: '‚úÖ',
		message: latestParticipantName
			? `O participante ${latestParticipantName} aceitou o convite.`
			: 'Nenhum participante confirmou presen√ßa ainda.',
		date: latestParticipantDate,
		order: 3
	},
	{
		icon: 'üéÅ',
		message: giftTheme ? `Tema do presente: ${giftTheme}.` : 'Tema do presente ainda n√£o definido.',
		date: null,
		order: 4
	},
	{
		icon: 'üìÖ',
		message: drawDate ? `Sorteio previsto para ${drawDate}.` : 'Sorteio ainda sem data definida.',
		date: drawDateTimestamp,
		order: 5
	},
	{
		icon: 'üéâ',
		message: revealDate ? `Revela√ß√£o prevista para ${revealDate}.` : 'Revela√ß√£o ainda sem data definida.',
		date: revealDateTimestamp,
		order: 6
	}
];

const timelineUpdates = timelineEventsRaw
	.sort((a, b) => {
		if (a.date && b.date) {
			return b.date.getTime() - a.date.getTime();
		}
		if (a.date && !b.date) return -1;
		if (!a.date && b.date) return 1;
		return a.order - b.order;
	})
	.map(({ icon, message }) => ({ avatar: icon, message }));

const group = {
	id: groupId,
	slug: (grupoRow as { slug: string }).slug,
	title: (grupoRow as { titulo: string }).titulo,
	description: (grupoRow as { descricao?: string | null }).descricao ?? 'Nenhuma descri√ß√£o adicionada ainda.',
	drawDate: drawDate ?? 'Data n√£o definida',
	revealDate: revealDate ?? 'Data n√£o definida',
	participants: participantCount,
	budget: budgetDescription,
	location: locationName ?? locationAddress ?? 'Local n√£o definido',
	locationName,
	locationAddress,
	locationLat: (grupoRow as { localizacao_lat?: number | null }).localizacao_lat ?? null,
	locationLng: (grupoRow as { localizacao_lng?: number | null }).localizacao_lng ?? null,
	status: groupStatus,
	details: {
		keyFacts,
		highlights,
		nextActions
	},
	participantsList
};

const messagesResult = await env.DB.prepare(
	`SELECT m.id, m.body, m.remetente_id, u.nome, u.email
	 FROM mensagem m
	 LEFT JOIN usuario u ON u.id = m.remetente_id
	 WHERE m.grupo_id = ?
	   AND m.is_secret = 0
	 ORDER BY datetime(m.criado_em) ASC
	 LIMIT 200`
)
	.bind(groupId)
	.all();

const messageHistory =
	(messagesResult?.results ?? []).map((row) => {
		const record = row as {
			id: string;
			body: string;
			remetente_id: string;
			nome?: string | null;
			email?: string | null;
		};
		const displayName = record.nome ?? record.email ?? 'Participante';
		return {
			id: record.id,
			body: record.body,
			authorId: record.remetente_id,
			initials: computeInitials(displayName)
		};
	}) ?? [];

const secretRecipientId = hasDraw ? yourDrawerId : null;
const secretMessagingAvailable = Boolean(secretRecipientId);
const secretModalForcedOpen =
	secretMessagingAvailable &&
	(Astro.url.searchParams.get('openSecret') ?? '').toLowerCase() === '1';

let secretMessageHistory =
	secretMessagingAvailable && secretRecipientId
		? (
				await env.DB.prepare(
					`SELECT m.id, m.body, m.remetente_id, m.recipiente_id, u.nome, u.email
					 FROM mensagem m
					 LEFT JOIN usuario u ON u.id = m.remetente_id
					 WHERE m.grupo_id = ?
					   AND m.is_secret = 1
					   AND (
					     (m.remetente_id = ? AND m.recipiente_id = ?)
					     OR (m.remetente_id = ? AND m.recipiente_id = ?)
					   )
					 ORDER BY datetime(m.criado_em) ASC
					 LIMIT 200`
				)
					.bind(groupId, userId, secretRecipientId, secretRecipientId, userId)
					.all()
			)?.results ?? []
		: [];

secretMessageHistory = secretMessageHistory.map((row) => {
	const record = row as {
		id: string;
		body: string;
		remetente_id: string;
		nome?: string | null;
		email?: string | null;
	};
	const isSelf = record.remetente_id === userId;
	return {
		id: record.id,
		body: record.body,
		authorId: record.remetente_id,
		initials: isSelf ? 'EU' : '??'
	};
});

const secretMessagesHtml = renderMessageList(secretMessageHistory, userId);
const secretRecipientIdValue = secretRecipientId ?? '';
const shouldAutoOpenSecretModal = Boolean(secretModalForcedOpen);
const initialSecretModalOpen = Boolean(secretMessageError || shouldAutoOpenSecretModal);

if (isOrganizer) {
	try {
		const pendingInviteRow = await env.DB.prepare(
			`SELECT COUNT(*) AS total
			 FROM convite
			 WHERE grupo_id = ?
			   AND (status IS NULL OR status != 'aceito')
			   AND enviado_em IS NOT NULL
			   AND datetime(enviado_em) <= datetime(?, '-24 hours')`
		)
			.bind(groupId, new Date().toISOString())
			.first();

		const pendingCount = Number(pendingInviteRow?.total ?? 0);
		if (pendingCount > 0) {
			await ensureNotification(
				organizerId,
				'Convites n√£o aceitos',
				`${pendingCount} convites ainda n√£o foram aceitos. Veja mais`,
				groupId
			);
		}
	} catch (error) {
		console.error('Erro ao verificar convites pendentes:', error);
	}
}
---

<Layout>
	<div class="min-h-screen bg-transparent">
		<AppHeader />

		<main class="mx-auto max-w-6xl space-y-12 px-6 py-12 lg:py-16">
			<a
				href="/app/painel"
				class="inline-flex items-center gap-2 text-sm font-medium text-[var(--color-text-muted)] hover:text-[var(--color-text)]"
			>
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
					<path
						fill-rule="evenodd"
						d="M12.78 4.22a.75.75 0 0 1 0 1.06L8.06 10l4.72 4.72a.75.75 0 1 1-1.06 1.06l-5.25-5.25a.75.75 0 0 1 0-1.06l5.25-5.25a.75.75 0 0 1 1.06 0z"
						clip-rule="evenodd"
					/>
				</svg>
				Voltar para o painel
			</a>

			<div class="flex flex-col lg:grid lg:grid-cols-[0.3fr_0.7fr] lg:gap-10 xl:gap-14">
				<aside class="order-2 mb-12 mt-10 space-y-6 lg:order-1 lg:mb-0 lg:mt-0">
					<h2 class="text-xl font-semibold text-[var(--color-text)]">√öltimas Atualiza√ß√µes</h2>
					<div class="grid gap-0">
						{timelineUpdates.map((update, index) => (
							<UpdateItem avatar={update.avatar} message={update.message} showConnector={index < timelineUpdates.length - 1} />
						))}
					</div>
				</aside>

				<div class="order-1 space-y-12 lg:order-2">
					<section class="space-y-6">
						<header class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
							<div class="space-y-2">
								<h1 class="text-4xl font-semibold text-[var(--color-text)]">{group.title}</h1>
								<p class="text-base text-[var(--color-text-muted)]">{group.description}</p>
							</div>
							<div class="flex items-center gap-2">
								{canEdit && (
									<div class="relative" x-data="{ open: false }">
										<button
											type="button"
											class="scroll-fade inline-flex items-center gap-2 rounded-full border border-[var(--color-border)] px-4 py-2 text-sm font-semibold text-[var(--color-text)] transition hover:text-[var(--color-primary)]"
											@click="open = !open"
											@keydown.escape.window="open = false"
										>
											Gerenciar grupo
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
												<path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.25a.75.75 0 0 1-1.06 0L5.21 8.29a.75.75 0 0 1 .02-1.08Z" clip-rule="evenodd" />
											</svg>
										</button>
										<div
											x-cloak
											x-show="open"
											@click.outside="open = false"
											class="absolute right-0 z-20 mt-2 w-48 rounded-2xl border border-[var(--color-border)] bg-[var(--color-surface)] py-2 shadow-[0_12px_32px_rgba(15,23,42,0.15)]"
										>
											<a
												href={`/app/grupo-novo?grupo=${slug}`}
												class="flex items-center gap-2 px-4 py-2 text-sm text-[var(--color-text)] transition hover:bg-[rgba(255,209,102,0.2)]"
												@click="open = false"
											>
												Editar grupo
											</a>
											<form
												hx-post={Astro.url.pathname + Astro.url.search}
												hx-swap="none"
												method="post"
												class="flex items-center gap-2 px-4 py-2 text-sm text-red-500 transition hover:bg-red-500/10"
												@click="open = false"
											>
												<input type="hidden" name="intent" value="deactivate-group" />
												<button type="submit" class="w-full text-left">Apagar grupo</button>
											</form>
										</div>
									</div>
								)}
								<ActionButton label="Compartilhar">
									<svg slot="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
										<path d="M13 5.5a2.5 2.5 0 1 1 .22 1.03l-5.454 3.09a2.5 2.5 0 0 1 0 .76l5.454 3.09a2.5 2.5 0 1 1-.48.877l-5.454-3.09a2.5 2.5 0 1 1 0-2.512l5.454-3.09A2.5 2.5 0 0 1 13 5.5Z" />
									</svg>
								</ActionButton>
							</div>
						</header>

						<div class="grid gap-6 text-[0.85rem]">
						<div class="grid gap-3 md:grid-cols-3">
								<div>
									<p class="text-[0.8rem] text-[var(--color-text-muted)]">Data da revela√ß√£o</p>
									<p class="mt-1 text-[var(--color-text)]">{group.revealDate}</p>
								</div>
								<div>
									<p class="text-[0.8rem] text-[var(--color-text-muted)]">Data do sorteio</p>
									<p class="mt-1 text-[var(--color-text)]">{group.drawDate}</p>
								</div>
								<div>
									<p class="text-[0.8rem] text-[var(--color-text-muted)]">Total participantes</p>
									<p class="mt-1 text-[var(--color-text)]">{group.participants}</p>
								</div>
							</div>

							<div class="grid gap-3 md:grid-cols-3">
								<div>
									<p class="text-[0.8rem] text-[var(--color-text-muted)]">Or√ßamento</p>
									<p class="mt-1 text-[var(--color-text)]">{group.budget}</p>
								</div>
								<div>
									<p class="text-[0.8rem] text-[var(--color-text-muted)]">Local</p>
									<p class="mt-1 text-[var(--color-text)]">{group.location}</p>
								</div>
								<div>
									<p class="text-[0.8rem] text-[var(--color-text-muted)]">√öltimo status</p>
									<p class="mt-1 text-[var(--color-text)]">{group.status}</p>
								</div>
							</div>
						</div>
						{canEdit && (
							<div class="space-y-2">
								<form
									method="post"
									class="flex justify-center"
									data-draw-form
									hx-post={Astro.url.pathname + Astro.url.search}
									hx-swap="none"
									hx-disabled-elt="[data-draw-submit]"
								>
									<input type="hidden" name="intent" value="draw" />
									<button
										type="submit"
										data-draw-submit
										class="scroll-fade inline-flex w-full max-w-sm items-center justify-center gap-3 rounded-full bg-[var(--color-primary)] px-6 py-4 text-base font-semibold text-[var(--color-primary-foreground)] shadow-[0_10px_24px_rgba(230,57,70,0.22)] transition hover:shadow-[0_14px_30px_rgba(230,57,70,0.3)]"
									>
										Fazer sorteio agora
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
											<path fill-rule="evenodd" d="M3.75 10a.75.75 0 0 1 .75-.75h8.69l-2.97-2.969a.75.75 0 0 1 1.06-1.062l4.25 4.25a.75.75 0 0 1 0 1.062l-4.25 4.25a.75.75 0 1 1-1.06-1.062l2.97-2.969H4.5A.75.75 0 0 1 3.75 10z" clip-rule="evenodd" />
										</svg>
									</button>
								</form>
								<p class={`text-xs text-center font-semibold text-red-500 ${drawError ? '' : 'hidden'}`} data-draw-error>
									{drawError ?? ''}
								</p>
							</div>
						)}
					</section>

	<section class="grid gap-4 md:grid-cols-2">
		<div
			x-data="{ reveal: false, hasDraw: $el.dataset.hasDraw === 'true' }"
			class="relative space-y-4 rounded-2xl border border-[var(--color-border)] bg-[var(--color-surface)] px-5 py-6 shadow-[0_12px_24px_rgba(109,76,65,0.12)]"
			data-has-draw={hasDraw ? 'true' : 'false'}
		>
				<div class="flex items-start justify-between">
					<h2 class="text-lg font-semibold text-[var(--color-text)]">Quem voc√™ tirou</h2>
					<button
						type="button"
						class="flex h-9 w-9 items-center justify-center rounded-full border border-[rgba(148,163,184,0.35)] text-[rgba(148,163,184,0.8)] transition hover:text-[var(--color-primary)]"
						@click="reveal = !reveal"
						:aria-pressed="reveal"
						:disabled="!hasDraw"
						:class="hasDraw ? '' : 'cursor-not-allowed opacity-50'"
					>
						<svg x-show="!reveal" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4" role="img" aria-label="Revelar">
							<path d="M12 5c-4.5 0-8.4 2.9-10 7 1.6 4.1 5.5 7 10 7s8.4-2.9 10-7c-1.6-4.1-5.5-7-10-7Zm0 12c-2.8 0-5-2.2-5-5s2.2-5 5-5 5 2.2 5 5-2.2 5-5 5Zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6Z" />
						</svg>
						<svg x-show="reveal" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4" x-cloak role="img" aria-label="Ocultar">
							<path d="M3.53 2.47a.75.75 0 0 0-1.06 1.06l2.228 2.228C2.77 7.091 1.57 8.7 1 10c1.6 4.1 5.5 7 10 7 1.76 0 3.42-.44 4.89-1.22l3.58 3.58a.75.75 0 1 0 1.06-1.06L3.53 2.47ZM12 15.5c-2.8 0-5-2.2-5-5 0-.69.14-1.34.38-1.94l1.53 1.53a3 3 0 0 0 3.53 3.53l1.53 1.53c-.6.24-1.25.38-1.94.38Zm0-10c1.76 0 3.42.44 4.89 1.22l-1.1 1.1a7.48 7.48 0 0 0-9.58 4.2c.2.51.45 1 .74 1.46l-1.12 1.12C4.8 12.18 3.3 10.83 2 10c1.6-4.1 5.5-7 10-7Zm0 3a2 2 0 0 1 1.96 1.64l-2.82 2.82A2 2 0 0 1 12 8.5Z" />
						</svg>
					</button>
				</div>
		<div class={`flex flex-col items-center gap-3 ${hasDraw ? '' : 'opacity-50'}`} :class="hasDraw && !reveal ? 'blur-md' : ''">
				<span class="flex h-16 w-16 items-center justify-center rounded-full border border-[rgba(230,57,70,0.35)] bg-[rgba(230,57,70,0.12)] text-base font-semibold uppercase text-[var(--color-primary)] shadow-[0_6px_14px_rgba(230,57,70,0.18)]">
							{recipientInitials}
						</span>
						<p class="text-sm text-[var(--color-text)]">{recipientDisplay}</p>
					</div>
					<div class="flex justify-center">
						<button
							type="button"
							class="scroll-fade inline-flex items-center gap-2 rounded-full border border-[var(--color-primary)] px-4 py-2 text-xs font-semibold text-[var(--color-primary)] hover:bg-[rgba(230,57,70,0.15)] disabled:cursor-not-allowed disabled:opacity-50"
							:class="hasDraw && !reveal ? 'blur-sm' : ''"
							:disabled="!hasDraw"
						>
							Ver a lista de desejos
						</button>
					</div>
				</div>

			<div
				x-data="{ hasDraw: $el.dataset.hasDraw === 'true' }"
				class="space-y-4 rounded-2xl border border-[var(--color-border)] bg-[var(--color-surface)] px-5 py-6 shadow-[0_12px_24px_rgba(109,76,65,0.12)]"
				data-has-draw={hasDraw ? 'true' : 'false'}
			>
					<h2 class="text-lg font-semibold text-[var(--color-text)]">Quem tirou voc√™</h2>
					<div class="flex flex-col items-center gap-3 text-center">
						<span class="flex h-16 w-16 items-center justify-center rounded-full border border-[rgba(42,157,143,0.35)] bg-[rgba(42,157,143,0.12)] text-base font-semibold uppercase text-[var(--color-text-muted)] shadow-[0_6px_14px_rgba(42,157,143,0.18)]">
							{drawerInitials}
						</span>
						<p class="text-sm text-[var(--color-text)]">{drawerDisplay}</p>
						<button
							type="button"
							class="scroll-fade inline-flex items-center gap-2 rounded-full border border-[rgba(148,163,184,0.35)] px-4 py-2 text-xs font-semibold text-[rgba(148,163,184,0.8)] hover:text-[var(--color-text)] disabled:cursor-not-allowed disabled:opacity-50"
							data-secret-open={secretMessagingAvailable ? 'true' : undefined}
							disabled={!secretMessagingAvailable}
						>
							Trocar mensagens
						</button>
					</div>
				</div>
	</section>

<section class="space-y-4" x-data="participantModal()">
	<div class="space-y-1">
		<h2 class="text-xl font-semibold text-[var(--color-text)]">Participantes</h2>
		<p class="text-sm text-[var(--color-text-muted)]">Clique no participante para ver sua lista de presentes.</p>
	</div>
	{participantEntries.length ? (
		<div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3">
			{participantEntries.map((participant) => (
				<button
					type="button"
					class="group flex flex-col gap-3 rounded-2xl border border-[var(--color-border)] bg-[var(--color-surface)] px-4 py-4 text-left shadow-[0_6px_14px_rgba(109,76,65,0.08)] transition hover:-translate-y-0.5 hover:border-[var(--color-primary)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--color-primary)]"
					data-participant={encodeURIComponent(JSON.stringify(participant.modalPayload))}
					@click="showParticipant($event)"
				>
					<div class="flex items-center gap-3">
						<span class="flex h-12 w-12 items-center justify-center rounded-full border border-[rgba(230,57,70,0.35)] bg-[rgba(230,57,70,0.12)] text-sm font-semibold uppercase text-[var(--color-primary)] shadow-[0_4px_10px_rgba(230,57,70,0.18)]">
							{participant.initials}
						</span>
						<div>
							<p class="text-sm font-semibold text-[var(--color-text)]">{participant.name}</p>
							<p class="text-xs text-[var(--color-text-muted)]">{participant.statusLabel}</p>
						</div>
					</div>
					{!participant.isConfirmed && participant.inviteTag && (
						<span class="inline-flex w-fit items-center rounded-full bg-[rgba(230,57,70,0.12)] px-3 py-1 text-[0.6rem] font-semibold uppercase  text-[var(--color-primary)]">
							{participant.inviteTag}
						</span>
					)}
				</button>
			))}
		</div>
	) : (
		<p class="rounded-2xl border border-dashed border-[var(--color-border)] bg-[var(--color-surface)] px-4 py-6 text-center text-sm text-[var(--color-text-muted)]">
			Nenhum participante foi convidado ainda. Convide algu√©m para come√ßar.
		</p>
	)}

	<script is:inline>
window.participantModal = function participantModal() {
	return {
		open: false,
		participant: null,
		showParticipant(event) {
			let payload = null;
			if (event && typeof event === 'object' && 'currentTarget' in event) {
				const raw = event.currentTarget?.dataset?.participant;
				if (raw) {
					try {
						payload = JSON.parse(decodeURIComponent(raw));
					} catch (error) {
						console.error('Erro ao abrir participante:', error);
					}
				}
			} else if (event) {
				payload = event;
			}

			if (!payload) return;
			if (payload.userId) {
				window.location.href = `/app/presentes/${encodeURIComponent(payload.userId)}`;
				return;
			}
			this.participant = payload;
			this.open = true;
			document.body.classList.add('overflow-hidden');
		},
		hideModal() {
			this.open = false;
			this.participant = null;
			document.body.classList.remove('overflow-hidden');
		}
	};
};
	</script>

	<div
		class="fixed inset-0 z-50 flex items-center justify-center bg-[rgba(0,0,0,0.45)] px-4 py-8"
		x-cloak
		x-show="open"
		x-transition.opacity
		@click.self="hideModal()"
		@keydown.escape.window="hideModal()"
	>
		<div
			class="w-full max-w-md rounded-3xl border border-[var(--color-border)] bg-[var(--color-surface)] p-6 shadow-[0_18px_36px_rgba(109,76,65,0.2)]"
			x-show="open"
			x-transition.scale
		>
			<div class="flex justify-end">
				<button
					type="button"
					class="flex h-9 w-9 items-center justify-center rounded-full border border-[var(--color-border)] text-[var(--color-text-muted)] transition hover:text-[var(--color-text)]"
					@click="hideModal()"
				>
					<span class="sr-only">Fechar</span>
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
						<path
							fill-rule="evenodd"
							d="M5.22 5.22a.75.75 0 0 1 1.06 0L10 8.94l3.72-3.72a.75.75 0 1 1 1.06 1.06L11.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06L10 11.06l-3.72 3.72a.75.75 0 1 1-1.06-1.06L8.94 10 5.22 6.28a.75.75 0 0 1 0-1.06Z"
							clip-rule="evenodd"
						/>
					</svg>
				</button>
			</div>
			<div class="flex flex-col items-center gap-4 text-center">
				<span class="flex h-16 w-16 items-center justify-center rounded-full border border-[rgba(230,57,70,0.35)] bg-[rgba(230,57,70,0.12)] text-base font-semibold uppercase text-[var(--color-primary)] shadow-[0_6px_16px_rgba(230,57,70,0.2)]">
					<span x-text="participant?.initials ?? ''"></span>
				</span>
				<div>
					<p class="text-2xl font-semibold text-[var(--color-text)]" x-text="participant?.name ?? ''"></p>
					<p class="mt-1 text-sm text-[var(--color-text-muted)]" x-text="participant?.status ?? ''"></p>
					<p
						class="text-xs text-[var(--color-text-muted)]"
						x-show="participant?.contact"
						x-text="participant?.contact ? 'Contato: ' + participant.contact : ''"
					></p>
				</div>
				<div class="flex w-full flex-col gap-3 sm:flex-row sm:justify-center">
					<template x-if="participant?.inviteId">
						<form
							hx-post={Astro.url.pathname + Astro.url.search}
							hx-swap="none"
							method="post"
							class="inline-flex flex-1"
						>
							<input type="hidden" name="intent" value="resend-invite" />
							<input type="hidden" name="invite_id" x-bind:value="participant?.inviteId ?? ''" />
							<button
								type="submit"
								class="scroll-fade inline-flex w-full items-center justify-center rounded-full bg-[var(--color-primary)] px-6 py-2 text-sm font-semibold tracking-normal text-[var(--color-primary-foreground)] shadow-[0_10px_24px_rgba(230,57,70,0.2)] transition hover:bg-[var(--color-primary)]/90"
							>
								Reenviar convite
							</button>
						</form>
					</template>
					<template x-if="participant?.inviteId">
						<form
							hx-post={Astro.url.pathname + Astro.url.search}
							hx-swap="none"
							method="post"
							class="inline-flex flex-1"
						>
							<input type="hidden" name="intent" value="delete-invite" />
							<input type="hidden" name="invite_id" x-bind:value="participant?.inviteId ?? ''" />
							<button
								type="submit"
								class="scroll-fade inline-flex w-full items-center justify-center rounded-full border border-red-400 px-6 py-2 text-sm font-semibold tracking-normal text-red-500 transition hover:bg-red-500/10"
							>
								Apagar convite
							</button>
						</form>
					</template>
				</div>
			</div>
		</div>
	</div>
</section>

		<section class="space-y-4">
			<h2 class="text-xl font-semibold text-[var(--color-text)]">Mensagens</h2>
			<div class="space-y-4 rounded-2xl border border-[var(--color-border)] bg-[var(--color-surface)] px-5 py-6 shadow-[0_12px_24px_rgba(109,76,65,0.12)]">
				<p class="text-sm text-[var(--color-text-muted)]">Interaja aqui com os outros membros do grupo</p>
				<div class="space-y-3 max-h-64 overflow-y-auto pr-1">
					{messageHistory.length ? (
						<Fragment set:html={renderMessageList(messageHistory, userId)} />
					) : (
						<p class="text-sm text-[var(--color-text-muted)]">Ainda n√£o h√° mensagens. Envie a primeira!</p>
					)}
				</div>
				<form method="post" class="flex flex-col gap-3 pt-2 sm:flex-row" novalidate>
					<input type="hidden" name="intent" value="message" />
					<label class="sr-only" for={`message-input-${groupId}`}>Mensagem</label>
					<input
						type="text"
						id={`message-input-${groupId}`}
						name="body"
						autocomplete="off"
						required
						value={draftMessage}
						class="flex-1 rounded-full border border-[var(--color-border)] bg-[rgba(255,209,102,0.25)] px-4 py-2 text-sm text-[var(--color-text)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
						placeholder="Escreva uma mensagem..."
					/>
					<button
						type="submit"
						class="scroll-fade inline-flex items-center justify-center gap-2 rounded-full border border-[var(--color-primary)] px-4 py-2 text-xs font-semibold text-[var(--color-primary)] hover:bg-[rgba(230,57,70,0.12)]"
					>
						Enviar
					</button>
				</form>
				{submissionError && (
					<p class="text-xs font-semibold text-red-500">{submissionError}</p>
				)}
			</div>
		</section>

		{secretMessagingAvailable && (
			<div
				class={`fixed inset-0 z-50 flex items-center justify-center bg-[rgba(15,23,42,0.45)] px-4 py-6 ${initialSecretModalOpen ? '' : 'hidden'}`}
				data-secret-modal
				data-secret-auto-open={shouldAutoOpenSecretModal ? 'true' : undefined}
			>
				<div class="w-full max-w-lg space-y-4 rounded-3xl border border-[var(--color-border)] bg-[var(--color-surface)] p-6 shadow-[0_24px_48px_rgba(15,23,42,0.35)]">
					<header class="flex items-start justify-between gap-3">
						<div>
							<h3 class="text-lg font-semibold text-[var(--color-text)]">Mensagens secretas</h3>
							<p class="text-xs text-[var(--color-text-muted)]">
								Envie mensagens privadas para o seu amigo secreto. Apenas voc√™s dois ver√£o essa conversa.
							</p>
						</div>
						<button
							type="button"
							class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-[var(--color-border)] text-[var(--color-text-muted)] hover:text-[var(--color-text)]"
							data-secret-close
							aria-label="Fechar mensagens secretas"
						>
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4">
								<path d="M6.225 4.811a.75.75 0 0 0-1.06 1.06L10.94 11.646 5.17 17.415a.75.75 0 0 0 1.06 1.061l5.77-5.77 5.768 5.77a.75.75 0 1 0 1.061-1.06l-5.77-5.77 5.77-5.77a.75.75 0 1 0-1.06-1.06l-5.77 5.768-5.774-5.773Z" />
							</svg>
						</button>
					</header>

					<div class="space-y-3 max-h-60 overflow-y-auto pr-1">
						{secretMessageHistory.length ? (
							<Fragment set:html={secretMessagesHtml} />
						) : (
							<p class="text-sm text-[var(--color-text-muted)]">
								Ainda n√£o h√° mensagens secretas. Inicie a conversa!
							</p>
						)}
					</div>

					<form method="post" class="space-y-3" novalidate>
						<input type="hidden" name="intent" value="secret-message" />
						<input type="hidden" name="recipient_id" value={secretRecipientIdValue} />
						<label class="flex flex-col gap-2 text-sm text-[var(--color-text)]">
							<span class="text-xs font-semibold uppercase tracking-[0.3em] text-[var(--color-text-muted)]">
								Nova mensagem
							</span>
							<textarea
								name="body"
								rows="3"
								required
								class="rounded-2xl border border-[var(--color-border)] bg-[rgba(255,209,102,0.25)] px-4 py-3 text-sm text-[var(--color-text)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
								placeholder="Escreva sua mensagem secreta..."
							>{secretDraft}</textarea>
						</label>
						{secretMessageError && (
							<p class="text-xs font-semibold text-red-500">{secretMessageError}</p>
						)}
						<div class="flex justify-end gap-2">
							<button
								type="button"
								class="inline-flex items-center gap-2 rounded-full border border-[var(--color-border)] px-4 py-2 text-xs font-semibold text-[var(--color-text-muted)] hover:text-[var(--color-text)]"
								data-secret-close
							>
								Cancelar
							</button>
							<button
								type="submit"
								class="scroll-fade inline-flex items-center gap-2 rounded-full bg-[var(--color-primary)] px-4 py-2 text-xs font-semibold text-[var(--color-primary-foreground)] shadow-[0_10px_24px_rgba(230,57,70,0.22)] transition hover:shadow-[0_14px_30px_rgba(230,57,70,0.3)]"
							>
								Enviar
							</button>
						</div>
					</form>
				</div>
			</div>
		)}

	</div>
	</div>
			</main>

			<Footer />
		</div>
	</Layout>

	<div
		class="fixed inset-0 z-[70] hidden items-center justify-center bg-[rgba(230,57,70,0.5)] backdrop-blur-sm"
		data-draw-loader
	>
		<div class="flex flex-col h-full items-center justify-center gap-4 text-[var(--color-primary-foreground)]">
			<div class="text-center">
				<lottie-player
					src="/Gift.json"
					background="transparent"
					speed="1"
					style="width: 300px; height: 300px;"
					loop
					autoplay
				></lottie-player>
				<p class="text-lg font-semibold">Gerando Amigos...</p>
			</div>
		</div>
	</div>

	<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js" defer></script>

	<script is:inline>
(() => {
	const form = document.querySelector('[data-draw-form]');
	const loader = document.querySelector('[data-draw-loader]');
	const submitButton = form?.querySelector('[data-draw-submit]');
	const errorPlaceholder = document.querySelector('[data-draw-error]');
	let hideTimer = null;
	if (!form || !loader) return;

	const showLoader = () => {
		if (hideTimer !== null) {
			clearTimeout(hideTimer);
			hideTimer = null;
		}
		loader.classList.add('flex');
		loader.classList.remove('hidden');
		if (submitButton instanceof HTMLButtonElement) {
			submitButton.setAttribute('disabled', 'true');
			submitButton.classList.add('opacity-75', 'pointer-events-none');
		}
	};

	const hideLoader = () => {
		if (hideTimer !== null) {
			clearTimeout(hideTimer);
		}
		hideTimer = window.setTimeout(() => {
			loader.classList.add('hidden');
			loader.classList.remove('flex');
			if (submitButton instanceof HTMLButtonElement) {
				submitButton.removeAttribute('disabled');
				submitButton.classList.remove('opacity-75', 'pointer-events-none');
			}
			hideTimer = null;
		}, 5000);
	};

	const setError = (message) => {
		if (!(errorPlaceholder instanceof HTMLElement)) return;
		errorPlaceholder.textContent = message;
		if (message) {
			errorPlaceholder.classList.remove('hidden');
		} else {
			errorPlaceholder.classList.add('hidden');
		}
	};

	const isDrawIntent = () => {
		const intentInput = form.querySelector('input[name="intent"]');
		return intentInput instanceof HTMLInputElement && intentInput.value === 'draw';
	};

	const shouldKeepLoader = (event) => {
		const xhr = event?.detail?.xhr;
		if (!xhr || typeof xhr.getResponseHeader !== 'function') return false;
		const redirectHeader = xhr.getResponseHeader('HX-Redirect');
		return typeof redirectHeader === 'string' && redirectHeader.length > 0;
	};

	if (!('htmx' in window) || !window.htmx) {
		form.addEventListener('submit', () => {
			if (!isDrawIntent()) return;
			setError('');
			showLoader();
		});
		return;
	}

	form.addEventListener('htmx:beforeRequest', (event) => {
		if (event.target !== form || !isDrawIntent()) return;
		setError('');
		showLoader();
	});

	form.addEventListener('htmx:afterRequest', (event) => {
		if (event.target !== form || !isDrawIntent()) return;
		if (shouldKeepLoader(event)) {
			return;
		}
		hideLoader();
	});

	form.addEventListener('htmx:responseError', (event) => {
		if (event.target !== form || !isDrawIntent()) return;
		const responseText = event.detail?.xhr?.responseText?.trim() ?? '';
		hideLoader();
		setError(responseText || 'N√£o foi poss√≠vel realizar o sorteio agora. Tente novamente.');
	});

	form.addEventListener('htmx:sendError', (event) => {
		if (event.target !== form || !isDrawIntent()) return;
		hideLoader();
		setError('N√£o foi poss√≠vel realizar o sorteio agora. Verifique sua conex√£o e tente novamente.');
	});
})();
	</script>

	{secretMessagingAvailable && (
		<script is:inline>
(() => {
	const modal = document.querySelector('[data-secret-modal]');
	if (!modal) return;

	let autoOpen = modal.dataset.secretAutoOpen === 'true';

	const clearAutoOpenQuery = () => {
		if (!autoOpen) return;
		try {
			const url = new URL(window.location.href);
			if (url.searchParams.has('openSecret')) {
				url.searchParams.delete('openSecret');
				const nextUrl = `${url.pathname}${url.search}${url.hash}`;
				window.history.replaceState({}, document.title, nextUrl);
			}
		} catch (error) {
			// noop: falha ao manipular URL n√£o deve impedir fluxo
		}
		autoOpen = false;
		modal.dataset.secretAutoOpen = 'false';
	};

	const showModal = () => {
		modal.classList.remove('hidden');
		clearAutoOpenQuery();
	};

	const hideModal = () => {
		modal.classList.add('hidden');
	};

	document.addEventListener('click', (event) => {
		const target = event.target && (event.target instanceof Element ? event.target : null);
		if (!target) return;

		if (target.closest('[data-secret-open]')) {
			event.preventDefault();
			showModal();
			return;
		}

		if (target.closest('[data-secret-close]')) {
			event.preventDefault();
			hideModal();
		}
	});

	modal.addEventListener('click', (event) => {
		if (event.target === modal) {
			hideModal();
		}
	});

	document.addEventListener('keydown', (event) => {
		if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
			hideModal();
		}
	});

	if (autoOpen && modal.classList.contains('hidden')) {
		showModal();
	} else if (autoOpen) {
		clearAutoOpenQuery();
	}
})();
		</script>
	)}
