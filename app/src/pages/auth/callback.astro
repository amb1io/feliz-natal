---
import { sendWelcomeEmail } from '../../../../shared/utils/email';

export const prerender = false;

console.log("callback:", Astro.request.url);
console.log(Astro.request.method, Astro.request.url);
const painelRedirect = "/app/painel";
const loginRedirect = "/app";
const invitationStatePrefix = "invitation:";

const env =
  Astro.locals.cloudflare?.env ??
  Astro.locals.runtime?.env ??
  Astro.locals?.env ??
  null;

const buildRedirectTarget = (state: string | null | undefined) => {
  if (!state) return painelRedirect;
  if (state.startsWith(invitationStatePrefix)) {
    try {
      const encodedTarget = state.slice(invitationStatePrefix.length);
      const decoded = decodeURIComponent(encodedTarget);
      if (decoded && decoded.startsWith("/")) {
        return decoded;
      }
    } catch (error) {
      console.warn("Não foi possível interpretar o parâmetro state.", error);
    }
  }
  return painelRedirect;
};

const normalizeBase64 = (value: string) =>
  value.replace(/-/g, "+").replace(/_/g, "/") +
  "=".repeat((4 - (value.length % 4)) % 4);

const decodeJwtPayload = (token: string) => {
  const segments = token.split(".");
  if (segments.length < 2) {
    throw new Error("Token JWT inválido.");
  }
  const payload = normalizeBase64(segments[1] ?? "");
  const json = Buffer.from(payload, "base64").toString("utf8");
  return JSON.parse(json) as Record<string, unknown>;
};

const params = new URL(Astro.request.url).searchParams;
const code = params.get("code");
const errorParam = params.get("error");
const errorDescription = params.get("error_description");
const state = params.get("state");

let errorMessage: string | null = null;
let welcomeEmailTarget: string | null = null;

if (errorParam) {
  const decodedDescription = errorDescription
    ? decodeURIComponent(errorDescription)
    : null;
  errorMessage = decodedDescription
    ? `${errorParam}: ${decodedDescription}`
    : errorParam;
} else if (!code) {
  console.log("asdad112");
  errorMessage = "Nenhum código de autorização foi retornado pelo Cognito.";
} else {
  try {
    const cognitoDomain = import.meta.env.PUBLIC_COGNITO_DOMAIN ?? "";
    const cognitoClientId = import.meta.env.PUBLIC_COGNITO_CLIENT_ID ?? "";
    const cognitoRedirectUri =
      import.meta.env.PUBLIC_COGNITO_REDIRECT_URI ??
      `${new URL(Astro.request.url).origin}/auth/callback`;
    const cognitoClientSecret =
      import.meta.env.COGNITO_CLIENT_SECRET ??
      import.meta.env.PRIVATE_COGNITO_CLIENT_SECRET ??
      null;

    console.log("asdad11");

    if (!cognitoDomain || !cognitoClientId) {
      throw new Error(
        "Configuração do Cognito ausente. Verifique as variáveis de ambiente."
      );
    }

    const tokenEndpoint = `https://${cognitoDomain}/oauth2/token`;
    console.log(tokenEndpoint);
    const tokenBody = new URLSearchParams({
      grant_type: "authorization_code",
      client_id: cognitoClientId,
      code,
      redirect_uri: cognitoRedirectUri,
    });

    const tokenHeaders: Record<string, string> = {
      "Content-Type": "application/x-www-form-urlencoded",
    };

    if (cognitoClientSecret) {
      const credentials = Buffer.from(
        `${cognitoClientId}:${cognitoClientSecret}`
      ).toString("base64");
      tokenHeaders.Authorization = `Basic ${credentials}`;
    }

    const tokenResponse = await fetch(tokenEndpoint, {
      method: "POST",
      headers: tokenHeaders,
      body: tokenBody.toString(),
    });

    if (!tokenResponse.ok) {
      const failurePayload = await tokenResponse.text();
      throw new Error(
        `Falha ao obter tokens do Cognito (${tokenResponse.status}): ${failurePayload || "sem detalhes"}`
      );
    }

    const tokenData = (await tokenResponse.json()) as {
      id_token?: string;
      access_token?: string;
      refresh_token?: string;
      [key: string]: unknown;
    };

    if (!tokenData.id_token) {
      throw new Error("Resposta do Cognito não contém ID token.");
    }

    const claims = decodeJwtPayload(tokenData.id_token);
    const userId = (claims.sub ?? claims.user_id) as string | undefined;
    if (!userId) {
      throw new Error("Dados do Cognito não possuem identificador (sub).");
    }

    const rawEmail =
      (claims.email as string | undefined) ??
      (claims.preferred_username as string | undefined) ??
      null;
    const fallbackEmail = `${userId}@placeholder.local`;
    const userEmail = rawEmail?.trim() || fallbackEmail;

    const providedName =
      typeof claims.name === "string" && claims.name.trim().length
        ? claims.name.trim()
        : null;

    const combinedName =
      [
        typeof claims.given_name === "string" ? claims.given_name.trim() : null,
        typeof claims.family_name === "string"
          ? claims.family_name.trim()
          : null,
      ]
        .filter(Boolean)
        .join(" ")
        .trim() || null;

    const resolvedName =
      providedName ??
      combinedName ??
      (rawEmail ? (rawEmail.split("@")[0] ?? "Participante") : "Participante");

    const agora = new Date().toISOString();

    if (env?.DB) {
      const db = env.DB;

      const existingById = await db
        .prepare("SELECT id, email FROM usuario WHERE id = ? LIMIT 1")
        .bind(userId)
        .first();

      if (existingById) {
        const currentEmail =
          ((existingById as { email?: string | null }).email ?? undefined)
            ?.toString()
            .trim() || userEmail;
        await db
          .prepare("UPDATE usuario SET nome = ?, email = ? WHERE id = ?")
          .bind(resolvedName, rawEmail ? userEmail : currentEmail, userId)
          .run();
      } else if (rawEmail) {
        const existingByEmail = await db
          .prepare("SELECT id FROM usuario WHERE email = ? LIMIT 1")
          .bind(userEmail)
          .first();

        if (existingByEmail?.id && existingByEmail.id !== userId) {
          await db
            .prepare(
              "UPDATE usuario SET id = ?, nome = ?, email = ?, criado_em = COALESCE(criado_em, ?) WHERE id = ?"
            )
            .bind(
              userId,
              resolvedName,
              userEmail,
              agora,
              existingByEmail.id as string
            )
            .run();
          welcomeEmailTarget = userEmail;
        } else {
          await db
            .prepare(
              "INSERT INTO usuario (id, nome, email, criado_em) VALUES (?, ?, ?, ?)"
            )
            .bind(userId, resolvedName, userEmail, agora)
            .run();
          welcomeEmailTarget = userEmail;
        }
      } else {
        await db
          .prepare(
            "INSERT INTO usuario (id, nome, email, criado_em) VALUES (?, ?, ?, ?)"
          )
          .bind(userId, resolvedName, userEmail, agora)
          .run();
      }
    } else {
      console.warn("DB não configurado; usuário não foi persistido.");
    }

    if (welcomeEmailTarget) {
      const dashboardUrl = new URL(painelRedirect, Astro.url).toString();
      await sendWelcomeEmail(env, {
        to: welcomeEmailTarget,
        name: resolvedName,
        dashboardUrl,
      });
    }

    const requestUrl = new URL(Astro.request.url);
    Astro.cookies.set("felizNatalSession", userId, {
      path: "/",
      maxAge: 60 * 60,
      sameSite: "Lax",
      secure: requestUrl.protocol === "https:",
      httpOnly: false,
    });

    const redirectTarget = buildRedirectTarget(state);
    return Astro.redirect(redirectTarget);
  } catch (error) {
    console.error("Erro ao processar o callback de autenticação:", error);
    errorMessage = "Não foi possível validar o login. Tente novamente.";
  }
}
console.log("sadsada");
---

<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Processando login...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        background: radial-gradient(
          circle at top,
          #172554,
          #0f172a 55%,
          #020617
        );
        color: #e0f2fe;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1.5rem;
      }
      main {
        width: min(480px, 100%);
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.18);
        border-radius: 2rem;
        padding: 2.5rem 2rem;
        box-shadow: 0 20px 60px rgba(8, 47, 73, 0.4);
        text-align: center;
        backdrop-filter: blur(18px);
      }
      h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }
      p {
        margin: 0.35rem 0;
        color: rgba(226, 232, 240, 0.9);
        line-height: 1.5;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.35rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.28em;
        border: 1px solid rgba(96, 165, 250, 0.4);
        background: rgba(37, 99, 235, 0.12);
        color: #bfdbfe;
        margin-bottom: 1.5rem;
      }
      .actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 2rem;
      }
      .button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.85rem 1rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition:
          transform 0.15s ease,
          box-shadow 0.2s ease,
          background 0.2s ease;
      }
      .button.primary {
        background: linear-gradient(135deg, #38bdf8, #2563eb);
        color: white;
        box-shadow: 0 12px 28px rgba(37, 99, 235, 0.35);
      }
      .button.primary:hover {
        transform: translateY(-1px);
      }
      .button.secondary {
        background: rgba(148, 163, 184, 0.12);
        color: #cbd5f5;
        border: 1px solid rgba(148, 163, 184, 0.25);
      }
      .button.secondary:hover {
        background: rgba(148, 163, 184, 0.2);
      }
      .status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        font-size: 0.85rem;
        color: rgba(226, 232, 240, 0.8);
      }
    </style>
  </head>
  <body>
    <main>
      <div class="badge">AWS Cognito</div>
      <h1>Não foi possível concluir o login</h1>
      <p>
        {
          errorMessage ??
            "Ocorreu um erro inesperado ao processar sua autenticação. Você pode tentar novamente."
        }
      </p>
      <div class="actions">
        <a href={loginRedirect} class="button primary">Voltar para o login</a>
        <a href={painelRedirect} class="button secondary">Ir para o painel</a>
      </div>
      <p class="status">
        Se o erro persistir, verifique a configuração do Cognito ou entre em
        contato com o suporte.
      </p>
    </main>
  </body>
</html>
