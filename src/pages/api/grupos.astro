---
export const prerender = false;

const env = Astro.locals.cloudflare?.env ?? Astro.locals.runtime?.env ?? Astro.locals?.env;
const session = Astro.cookies.get('felizNatalSession')?.value ?? null;

let grupos: Array<{
	id: string;
	slug: string;
	titulo: string;
	descricao: string | null;
	status: string;
	criado_em: string | null;
}> = [];

if (env?.DB && session) {
	try {
		const statement = env.DB.prepare(
			`SELECT id, slug, titulo, descricao, status, criado_em
			 FROM grupo
			 WHERE criado_por = ?
			 UNION
			 SELECT g.id, g.slug, g.titulo, g.descricao, g.status, g.criado_em
			 FROM grupo g
			 JOIN grupo_participante gp
			   ON gp.grupo_id = g.id
			  AND gp.usuario_id = ?
			  AND gp.is_ativo = 1
			 ORDER BY 6 DESC
			 LIMIT 3`
		).bind(session, session);

		const result = await statement.all();
		grupos = (result?.results ?? []) as typeof grupos;
	} catch (error) {
		console.error('Erro ao consultar grupos:', error);
	}
}

const formatDate = (value?: string | null) =>
  value ? new Date(value).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' }) : null;
---
{grupos.length ? (
  grupos.map((grupo) => (
    <article class="rounded-3xl border border-[var(--color-border)] bg-[var(--color-surface)] px-5 py-6 shadow-[0_12px_24px_rgba(109,76,65,0.12)]">
      <header class="flex items-center justify-between gap-3">
        <h3 class="text-lg font-semibold text-[var(--color-text)]">{grupo.titulo}</h3>
        <span class="rounded-full bg-[rgba(230,57,70,0.12)] px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-[var(--color-primary)]">
          {grupo.status}
        </span>
      </header>
      {grupo.descricao && (
        <p class="mt-3 text-sm text-[var(--color-text-muted)]">
          {grupo.descricao}
        </p>
      )}
      <footer class="mt-4 flex items-center justify-between text-xs text-[var(--color-text-muted)]">
        <span>
          Criado em {formatDate(grupo.criado_em) ?? 'data desconhecida'}
        </span>
        <a href={`/app/grupo/${grupo.slug}`} class="inline-flex items-center gap-1 font-semibold text-[var(--color-primary)] hover:underline">
          Ver detalhes
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
            <path fill-rule="evenodd" d="M3 10a.75.75 0 0 1 .75-.75h9.19l-2.47-2.47a.75.75 0 0 1 1.06-1.06l3.75 3.75a.75.75 0 0 1 0 1.06l-3.75 3.75a.75.75 0 1 1-1.06-1.06l2.47-2.47H3.75A.75.75 0 0 1 3 10Z" clip-rule="evenodd" />
          </svg>
        </a>
      </footer>
    </article>
  ))
) : (
  <div class="col-span-full rounded-3xl border border-dashed border-[var(--color-border)] bg-[rgba(42,157,143,0.05)] px-6 py-10 text-center text-sm text-[var(--color-text-muted)]">
    Nenhum grupo encontrado. Crie um grupo para come√ßar!
  </div>
)}
